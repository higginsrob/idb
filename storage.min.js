/*
  ============================================================================================
  storage.js
  AMD module for managing IndexedDB (with Promises), localStorage, sessionStorage, and cookies
  ============================================================================================
  @license Open source under MIT
  Copyright 2015 Robert Higgins All rights reserved
  ============================================================================================
  global Promise
  ============================================================================================
*/
define("undefined"==typeof Promise?["./npo.js"]:[],function(){var e=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}(),o=function(){try{return"localStorage"in window&&null!==window.sessionStorage}catch(e){return!1}}(),t=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB,n=window.IDBKeyRange||window.webkitIDBKeyRange,r=function(e){var o=this;this.closed=!1,this.add=function(t,n,r){if(o.closed)throw"Database has been closed";return new Promise(function(c,i){var a=e.transaction(t,"readwrite"),s=a.objectStore(t);"[object Object]"===Object.prototype.toString.call(n)&&(n=[n]),n.forEach(function(e){var o=s.add(e);o.onsuccess=function(o){"function"==typeof callback&&r(o,e)}}),a.oncomplete=function(){c(n,o)},a.onerror=i,a.onabort=i})},this["delete"]=function(t,n,r){if(o.closed)throw"Database has been closed";return new Promise(function(o,c){var i=e.transaction(t,"readwrite"),a=i.objectStore(t);"[object String]"===Object.prototype.toString.call(n)&&(n=[n]),n.forEach(function(e){var o=a["delete"](e);o.onsuccess=function(o){"function"==typeof callback&&r(o,e)}}),i.oncomplete=function(){o(n)},i.onerror=c,i.onabort=c})},this.clear=function(t){if(o.closed)throw new Error("Database has been closed");return new Promise(function(o,n){var r=e.transaction(t,"readwrite"),c=r.objectStore(t);c.clear(),r.oncomplete=function(){o(!0)},r.onerror=function(){n(!1)},r.onabort=function(){n(!1)}})},this.count=function(t){if(o.closed)throw new Error("Database has been closed");return new Promise(function(o,n){var r=e.transaction(t,"readonly"),c=r.objectStore(t),i=c.count();r.oncomplete=function(){o(i.result)},r.onerror=n,r.onabort=n})},this.get=function(t,n,r){if(o.closed)throw new Error("Database has been closed");return new Promise(function(o,c){var i=e.transaction(t,"readwrite"),a=i.objectStore(t),s=a.get(n);s.onsuccess=function(e){"function"==typeof r&&r(e,s.result)},i.oncomplete=function(){o(s.result)},i.onerror=c,i.onabort=c})},this.update=function(t,n,r){if(o.closed)throw new Error("Database has been closed");return new Promise(function(o,c){var i=e.transaction(t,"readwrite"),a=i.objectStore(t);"[object Object]"===Object.prototype.toString.call(n)&&(n=[n]),n.forEach(function(e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("you must use an object to modify changes");if(!e[a.keyPath])throw new Error("you must specify the index key in your modify object");var o=a.get(e[a.keyPath]);o.onsuccess=function(t){var n=o.result;Object.keys(e).forEach(function(o){n[o]=e[o]});var i=a.put(n);i.onsuccess=function(o){"function"==typeof r&&r(o,n,e)},i.onerror=c,i.onabort=c}}),i.oncomplete=function(){o(n)},i.onerror=c,i.onabort=c})},this.query=function(t,r,c){if(o.closed)throw new Error("Database has been closed");return new Promise(function(o,i){var a=e.transaction(t,"readonly"),s=a.objectStore(t),u=[];"[object Object]"===Object.prototype.toString.call(r)&&(r.lower&&r.upper?r=n.bound(r.lower,r.upper):r.only?r=n.only(r.only):r.lower?r=n.lowerBound(r.lower):r.upper&&(r=n.upperBound(r.upper))),s.openCursor(r).onsuccess=function(e){var o=e.target.result;o&&(u.push(o.value),"function"==typeof c&&c(e,o.value),o["continue"]())},a.oncomplete=function(){o(u)},a.onerror=i,a.onabort=i})},this.close=function(){if(this.closed)throw new Error("Database is already closed");e.close(),this.closed=!0}};return{cookie:{clear:function(){var e=document.cookie.split("; ");e.forEach(function(e){document.cookie=e.split("=")[0]+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"})},getItem:function(e){var o,t=document.cookie.split("; ");return t.forEach(function(t){return t.split("=")[0]===e?(o=t.split("=")[1],!1):void 0}),o},key:function(e){var o=document.cookie.split("; ");return o[e].split("=")[0]},keys:function(){var e=[],o=document.cookie.split("; ");return o.forEach(function(o){e.push(o.split("=")[0])}),e},setItem:function(e,o,t){t||(t=Date.now()),document.cookie=e+"="+o+"; expires="+t},removeItem:function(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}},local:{clear:function(o){e&&localStorage.clear()},getItem:function(o,t){if(e){var n=localStorage.getItem(o);return null===n?void 0===t?null:t:n}},key:function(o){return e?localStorage.key(o):void 0},keys:function(){if(e){for(var o,t=[],n=0;o=localStorage.key(n);)t.push(o),n++;return t}},setItem:function(e,t){o&&localStorage.setItem(e,t)},removeItem:function(e){o&&localStorage.removeItem(e)}},session:{clear:function(e){o&&sessionStorage.clear()},getItem:function(e,t){if(o){var n=sessionStorage.getItem(e);return null===n?void 0===t?null:t:n}},key:function(e){return o?sessionStorage.key(e):void 0},keys:function(){if(o){for(var e,t=[],n=0;e=sessionStorage.key(n);)t.push(e),n++;return t}},setItem:function(e,t){o&&sessionStorage.setItem(e,t)},removeItem:function(e){o&&sessionStorage.removeItem(e)}},db:function(e){if(!t)throw new Error("IndexedDB required");return new Promise(function(o,n){var c=t.open(e.name,e.version);c.onsuccess=function(e){o(new r(e.target.result))},c.onupgradeneeded=function(o){var t=o.target.result;Object.keys(e.schema).forEach(function(o){var n=e.schema[o],r=t.createObjectStore(o,n.key);"[object Object]"===Object.prototype.toString.call(n.indexes)&&Object.keys(n.indexes).forEach(function(e){try{r.index(e)}catch(o){r.createIndex(e,n.indexes[e].key||e,Object.keys(n.indexes[e]).length?n.indexes[e]:{unique:!1})}})})},c.onerror=n})}}});